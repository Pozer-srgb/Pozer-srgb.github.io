document.addEventListener('DOMContentLoaded', () => {
    let isButtonBusy = false;

    const elements = {
        button: document.getElementById('myButton'),
        audio: document.getElementById('clickSound')
    };

    elements.audio.preload = 'metadata';

    function updateThemeColor() {
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (document.body.classList.contains('alternate-theme')) {
            metaThemeColor.setAttribute('content', '#34495e');
        } else {
            metaThemeColor.setAttribute('content', '#2ecc71');
        }
    }

    const observerConfig = {
        threshold: 0.2,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const delay = entry.target.dataset.animateDelay || 0;
                setTimeout(() => {
                    entry.target.classList.add('animate-fadein');
                }, Number(delay));
                observer.unobserve(entry.target);
            }
        });
    }, observerConfig);

    document.querySelectorAll('[data-animate]').forEach(element => {
        observer.observe(element);
    });

    const buttonTexts = {
        true: 'ðŸŒž Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñ‚ÐµÐ¼Ñƒ',
        false: 'ðŸŒ“ ÐÐ°Ð¶Ð¼Ð¸ Ð¼ÐµÐ½Ñ!'
    };

    function updateButtonText() {
        const isDark = document.body.classList.contains('alternate-theme');
        elements.button.textContent = buttonTexts[isDark];
        elements.button.setAttribute (
            'aria-label',
            isDark ? 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ²ÐµÑ‚Ð»ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ' : 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ñ‘Ð¼Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ'
        );
    }

    if (!elements.button) {
        console.error('ÐšÐ½Ð¾Ð¿ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°');
    }

    if (!elements.audio) {
        console.error('ÐÑƒÐ´Ð¸Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾');
    }

    try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.classList.add(savedTheme);
            updateButtonText();
            updateThemeColor();
        }
    } catch (e) {
        console.log('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‚ÐµÐ¼Ñ‹');
    }

    elements.button.addEventListener('click', () => {
        if (isButtonBusy) return;

        isButtonBusy = true;

        elements.audio.play().catch((error) => {
            console.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ñ:', error.message);
            elements.button.setAttribute('aria-label', 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð´Ð»Ñ Ð·Ð²ÑƒÐºÐ°');
            elements.button.disabled = true;
        });
        document.body.classList.toggle('alternate-theme');
        localStorage.setItem('theme', document.body.classList.contains('alternate-theme') ? 'alternate-theme' : '');
        updateButtonText();
        updateThemeColor();

        setTimeout(() => {
            isButtonBusy = false;
        }, 500);
    });

    window.addEventListener ('load', () => {
        elements.button.classList.add('loaded');
    });

    // Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð±Ð°Ñ€Ð° Ð½Ð°Ð²Ñ‹ÐºÐ¾Ð²
    const chartObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.width = entry.target.dataset.level + '%';
            }
        });
    }, {threshold: 0.5});

    document.querySelectorAll('.skill-bar').forEach(bar => {
        chartObserver.observe(bar);
    });
});